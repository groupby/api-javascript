"use strict";function __export(e){for(var t in e)exports.hasOwnProperty(t)||(exports[t]=e[t])}global.Promise||require("es6-promise").polyfill(),__export(require("./core/query")),__export(require("./core/bridge")),__export(require("./request-models")),__export(require("./util"));var Request=function(){function e(){}return e}();exports.Request=Request;var assign=require("object-assign"),NavigationConverter=function(){function e(){}return e.convert=function(e){return e.reduce(function(e,t){return t.refinements.forEach(function(r){return e.push(assign(r,{navigationName:t.name}))}),e},[])},e}();exports.NavigationConverter=NavigationConverter;var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},axios=require("axios"),assign=require("object-assign"),query_1=require("./query"),SEARCH="/search",REFINEMENTS="/refinements",REFINEMENT_SEARCH="/refinement",CLUSTER="/cluster",BIASING_DEFAULTS={biases:[],bringToTop:[],augmentBiases:!1},AbstractBridge=function(){function e(){}return e.prototype.search=function(e,t){void 0===t&&(t=void 0);var r=this.extractRequest(e),i=r[0],n=r[1];if(null===i)return this.generateError("query was not of a recognised type",t);var s=this.fireRequest(this.bridgeUrl,i,n);return t?void s.then(function(e){return t(void 0,e)})["catch"](function(e){return t(e)}):s},e.prototype.extractRequest=function(e){switch(typeof e){case"string":return[new query_1.Query(e).build(),{}];case"object":return e instanceof query_1.Query?[e.build(),e.queryParams]:[e,{}];default:return[null,null]}},e.prototype.generateError=function(e,t){var r=new Error(e);return t?void t(r):Promise.reject(r)},e.prototype.fireRequest=function(e,t,r){var i=this,n={url:this.bridgeUrl,method:"post",params:r,data:this.augmentRequest(t),responseType:"json",timeout:1500};return axios(n).then(function(e){return e.data}).then(function(e){return e.records?assign(e,{records:e.records.map(i.convertRecordFields)}):e})},e.prototype.convertRecordFields=function(e){var t=assign(e,{id:e._id,url:e._u,title:e._t});return delete t._id,t._u,t._t,e._snippet&&(t.snippet=e._snippet,delete t._snippet),t},e}();exports.AbstractBridge=AbstractBridge;var CloudBridge=function(e){function t(t,r){e.call(this),this.clientKey=t,this.bridgeRefinementsUrl=null,this.bridgeRefinementsSearchUrl=null,this.bridgeClusterUrl=null;var i="https://"+r+".groupbycloud.com:443/api/v1";this.bridgeUrl=i+SEARCH,this.bridgeRefinementsUrl=i+REFINEMENTS,this.bridgeRefinementsSearchUrl=i+REFINEMENT_SEARCH,this.bridgeClusterUrl=i+CLUSTER}return __extends(t,e),t.prototype.augmentRequest=function(e){return assign(e,{clientKey:this.clientKey})},t}(AbstractBridge);exports.CloudBridge=CloudBridge;var BrowserBridge=function(e){function t(t){e.call(this),this.bridgeUrl="http://ecomm.groupbycloud.com/semanticSearch/"+t}return __extends(t,e),t.prototype.augmentRequest=function(e){return e},t}(AbstractBridge);exports.BrowserBridge=BrowserBridge;var assign=require("object-assign"),qs=require("qs"),request_models_1=require("../request-models"),util_1=require("../util"),Query=function(){function e(e){void 0===e&&(e=""),this.request={},this.unprocessedNavigations=[],this.queryParams={},this.request.query=e,this.request.sort=[],this.request.fields=[],this.request.orFields=[],this.request.refinements=[],this.request.customUrlParams=[],this.request.includedNavigations=[],this.request.excludedNavigations=[],this.request.wildcardSearchEnabled=!1,this.request.pruneRefinements=!0}return e.prototype.withConfiguration=function(e){return assign(this.request,e),this},e.prototype.withSelectedRefinements=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return(r=this.request.refinements).push.apply(r,e),this;var r},e.prototype.withRefinements=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var i=function(t){return assign(t,{navigationName:e})};return(n=this.request.refinements).push.apply(n,t.map(i)),this;var n},e.prototype.withNavigations=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return(r=this.unprocessedNavigations).push.apply(r,e),this;var r},e.prototype.withCustomUrlParams=function(e){return"string"==typeof e?(t=this.request.customUrlParams).push.apply(t,this.convertParamString(e)):e instanceof Array&&(r=this.request.customUrlParams).push.apply(r,e),this;var t,r},e.prototype.convertParamString=function(e){var t=qs.parse(e);return Object.keys(t).reduce(function(e,r){return e.concat({key:r,value:t[r]})},[])},e.prototype.withFields=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return(r=this.request.fields).push.apply(r,e),this;var r},e.prototype.withOrFields=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return(r=this.request.orFields).push.apply(r,e),this;var r},e.prototype.withSorts=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return(r=this.request.sort).push.apply(r,e),this;var r},e.prototype.withIncludedNavigations=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return(r=this.request.includedNavigations).push.apply(r,e),this;var r},e.prototype.withExcludedNavigations=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return(r=this.request.excludedNavigations).push.apply(r,e),this;var r},e.prototype.withQueryParams=function(e){switch(typeof e){case"string":return assign(this,{queryParams:this.convertQueryString(e)});case"object":return assign(this,{queryParams:e})}},e.prototype.convertQueryString=function(e){return qs.parse(e)},e.prototype.refineByValue=function(e,t,r){return void 0===r&&(r=!1),this.withSelectedRefinements({navigationName:e,value:t,exclude:r,type:"Value"})},e.prototype.refineByRange=function(e,t,r,i){return void 0===i&&(i=!1),this.withSelectedRefinements({navigationName:e,low:t,high:r,exclude:i,type:"Range"})},e.prototype.restrictNavigation=function(e){return this.request.restrictNavigation=e,this},e.prototype.skip=function(e){return this.request.skip=e,this},e.prototype.withPageSize=function(e){return this.request.pageSize=e,this},e.prototype.withMatchStrategy=function(e){return this.request.matchStrategy=e,this},e.prototype.withBiasing=function(e){return this.request.biasing=e,this},e.prototype.enableWildcardSearch=function(){return this.request.wildcardSearchEnabled=!0,this},e.prototype.disableAutocorrection=function(){return this.request.disableAutocorrection=!0,this},e.prototype.disableBinaryPayload=function(){return this.request.returnBinary=!1,this},e.prototype.allowPrunedRefinements=function(){return this.request.pruneRefinements=!1,this},e.prototype.build=function(){var e=assign(new request_models_1.Request,this.request);return(t=e.refinements).push.apply(t,util_1.NavigationConverter.convert(this.unprocessedNavigations)),this.clearEmptyArrays(e);var t},e.prototype.clearEmptyArrays=function(e){for(var t in e)e[t]instanceof Array&&0===e[t].length&&delete e[t];return e},e}();exports.Query=Query;